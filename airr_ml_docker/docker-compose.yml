# =============================================================================
# AIRR-ML Docker Compose Configuration
# =============================================================================
# Run multiple datasets easily with docker-compose
#
# Usage:
#   # Set your data paths in .env file or export them
#   export DATA_DIR=/path/to/your/data
#   export OUTPUT_DIR=/path/to/output
#
#   # Run ANY dataset using DATASET_NUM (works for 1, 50, 100, etc.)
#   DATASET_NUM=1 docker-compose run --rm airr-ml
#   DATASET_NUM=50 docker-compose run --rm airr-ml
#   DATASET_NUM=100 docker-compose run --rm airr-ml
#
#   # Or use pre-defined shortcuts for datasets 1-8
#   docker-compose run --rm dataset1
#
#   # Run with custom settings
#   AIRR_MODELS="vj,kmer4" docker-compose run --rm dataset1
# =============================================================================

version: '3.8'

services:
  # Base service template (not run directly)
  airr-ml-base: &airr-base
    build:
      context: .
      dockerfile: Dockerfile
    image: airr-ml:v9
    volumes:
      - ${DATA_DIR:-./data}:/data:ro
      - ${OUTPUT_DIR:-./output}:/output
    environment:
      - AIRR_MODELS=${AIRR_MODELS:-vj,kmer4,kmer56,gapped,pos_kmer,diversity,pos_aa,emerson,malidvj}
      - TASK2_MODEL_OVERRIDE=${TASK2_MODEL_OVERRIDE:-BEST}
      - TASK2_USE_TEST_DATA=${TASK2_USE_TEST_DATA:-1}
      - AIRR_ENSEMBLE_MODE=${AIRR_ENSEMBLE_MODE:-standard}

  # =============================================================================
  # GENERIC SERVICE - Run ANY dataset by setting DATASET_NUM
  # =============================================================================
  # Usage: DATASET_NUM=50 docker-compose run --rm airr-ml
  # =============================================================================
  airr-ml:
    <<: *airr-base
    command: >
      --train_dir /data/train_datasets/train_dataset_${DATASET_NUM:-1}
      --test_dirs /data/test_datasets/test_dataset_${DATASET_NUM:-1}
      --out_dir /output/dataset_${DATASET_NUM:-1}
      --n_jobs 16

  # =============================================================================
  # PRE-DEFINED SHORTCUTS FOR DATASETS 1-8
  # =============================================================================

  # Dataset 1
  dataset1:
    <<: *airr-base
    command: >
      --train_dir /data/train_datasets/train_dataset_1
      --test_dirs /data/test_datasets/test_dataset_1
      --out_dir /output/dataset_1
      --n_jobs 16

  # Dataset 2
  dataset2:
    <<: *airr-base
    command: >
      --train_dir /data/train_datasets/train_dataset_2
      --test_dirs /data/test_datasets/test_dataset_2
      --out_dir /output/dataset_2
      --n_jobs 16

  # Dataset 3
  dataset3:
    <<: *airr-base
    command: >
      --train_dir /data/train_datasets/train_dataset_3
      --test_dirs /data/test_datasets/test_dataset_3
      --out_dir /output/dataset_3
      --n_jobs 16

  # Dataset 4
  dataset4:
    <<: *airr-base
    command: >
      --train_dir /data/train_datasets/train_dataset_4
      --test_dirs /data/test_datasets/test_dataset_4
      --out_dir /output/dataset_4
      --n_jobs 16

  # Dataset 5
  dataset5:
    <<: *airr-base
    command: >
      --train_dir /data/train_datasets/train_dataset_5
      --test_dirs /data/test_datasets/test_dataset_5
      --out_dir /output/dataset_5
      --n_jobs 16

  # Dataset 6
  dataset6:
    <<: *airr-base
    command: >
      --train_dir /data/train_datasets/train_dataset_6
      --test_dirs /data/test_datasets/test_dataset_6
      --out_dir /output/dataset_6
      --n_jobs 16

  # Dataset 7 (multiple test sets)
  dataset7:
    <<: *airr-base
    command: >
      --train_dir /data/train_datasets/train_dataset_7
      --test_dirs /data/test_datasets/test_dataset_7_1 /data/test_datasets/test_dataset_7_2
      --out_dir /output/dataset_7
      --n_jobs 16

  # Dataset 8 (multiple test sets)
  dataset8:
    <<: *airr-base
    command: >
      --train_dir /data/train_datasets/train_dataset_8
      --test_dirs /data/test_datasets/test_dataset_8_1 /data/test_datasets/test_dataset_8_2 /data/test_datasets/test_dataset_8_3
      --out_dir /output/dataset_8
      --n_jobs 16
